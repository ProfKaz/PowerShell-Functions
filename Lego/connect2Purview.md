# Function to connect to Purview Services

This function utilizes the `Office 365 Exchange Online API`, enabling the execution of cmdlets typically available to admin users. It relies on a [Configuration File](/Lego/CreateConfigFile.md) containing details for the [Microsoft Entra Application](/Lego/CreateNewEntraApp.md) created for this purpose. To establish an automatic connection, you’ll need the application’s ID, the tenant’s OnMicrosoft URL, and a certificate thumbprint generated by the previous function.

> [!WARNING]
> To use this API, the service principal must have the necessary admin permissions for the cmdlets being executed.

```powershell
function connect2service
{	
	ValidateConfigurationFile	
	<#
	.NOTES
	If you cannot add the "Compliance Administrator" role to the Microsoft Entra App, for security reasons, you can execute with "Compliance Administrator" role 
	this script using .\MPARR-PurviewRoles.ps1 -ManualConnection
	#>
	if($ManualConnection)
	{
		Write-Host "`nAuthentication is required, please check your browser" -ForegroundColor Green
		Connect-IPPSSession -UseRPSSession:$false 
	}else
	{
		$CONFIGFILE = "$PSScriptRoot\ConfigFiles\laconfig.json"
		$json = Get-Content -Raw -Path $CONFIGFILE
		[PSCustomObject]$config = ConvertFrom-Json -InputObject $json
		
		$EncryptedKeys = $config.EncryptedKeys
		$AppClientID = $config.AppClientID
		$CertificateThumb = $config.CertificateThumb
		$OnmicrosoftTenant = $config.OnmicrosoftURL
		if ($EncryptedKeys -eq "True")
		{
			$CertificateThumb = DecryptSharedKey $CertificateThumb
		}
		$status = CheckCertificateInstalled -thumbprint $CertificateThumb
		
		if($status -eq "True")
		{
			Connect-IPPSSession -CertificateThumbPrint $CertificateThumb -AppID $AppClientID -Organization $OnmicrosoftTenant 
		}else
		{
			Write-Host "`nThe Certificate set in laconfig.json don't match with the certificates installed on this machine, you can try to execute using manual connection, to do that extecute: "
			Write-Host ".\MyScript.ps1 -ManualConnection" -ForeGroundColor Green
			exit
		}
		
	}
}
```
<br><br>
